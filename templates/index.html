<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Personalized Music Search</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <div class="user-container">
        <span>Welcome, <b>{{ current_user.display_name }}</b></span>
        {% if current_user.profile_image %}
            <img src="{{ current_user.profile_image }}" alt="Profile" class="profile-image">
        {% endif %}
        <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
    </div>

    <div class="main-content">
        <h1>Personalized Spotify Music Search</h1>
        <p>Search for a song, album, or artist</p>

        <button class="show-top-items-btn" id="show-top-items">
            <i class="fas fa-chart-line"></i> See My Top Tracks & Artists
        </button>

        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search...">
            <button id="search-button">Search</button>
        </div>

        <div id="top-items-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div class="user-top-content">
                    <div class="top-tracks-section">
                        <h2>Your Top Tracks</h2>
                        <div id="top-tracks-container" class="top-items-grid"></div>
                    </div>

                    <div class="top-artists-section">
                        <h2>Your Top Artists</h2>
                        <div id="top-artists-container" class="top-items-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading">Searching...</div>

        <div id="error-message" class="error-message"></div>

        <div id="results" class="results">
            <div id="ranked-results"></div>
        </div>

        <!-- Metadata Modal -->
        <div id="metadata-modal" class="modal">
            <div class="modal-content">
                <span class="close-metadata-modal">&times;</span>
                <h2>Result Details</h2>
                <div id="metadata-content"></div>
            </div>
        </div>
    </div>

    <div id="player-bar" class="player-bar">
        <div class="player-info">
            <img src="" alt="" id="player-album-art">
            <div class="player-song-info">
                <span id="player-song-name"></span>
                <span id="player-artist-name"></span>
            </div>
        </div>
        <div class="progress-container">
            <div class="player-controls">
                <button class="control-button"><i class="fas fa-backward"></i></button>
                <button class="control-button play-button" id="play-pause-button">
                    <i class="fas fa-play" id="play-pause-icon"></i>
                </button>
                <button class="control-button"><i class="fas fa-forward"></i></button>
            </div>
            <div class="progress-bar">
                <div class="progress" id="song-progress"></div>
                <div class="time-info">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>
        </div>
        <div class="player-volume">
            <i class="fas fa-volume-up"></i>
            <div class="volume-slider">
                <div class="volume-progress"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error-message');
            const rankedResultsDiv = document.getElementById('ranked-results');

            // Metadata Modal elements
            const metadataModal = document.getElementById('metadata-modal');
            const closeMetadataModal = document.querySelector('.close-metadata-modal');

            // Close metadata modal when clicking the close button or outside
            closeMetadataModal.addEventListener('click', () => {
                metadataModal.classList.remove('show');
                setTimeout(() => {
                    metadataModal.style.display = 'none';
                }, 300);
            });

            window.addEventListener('click', (event) => {
                if (event.target === metadataModal) {
                    metadataModal.classList.remove('show');
                    setTimeout(() => {
                        metadataModal.style.display = 'none';
                    }, 300);
                }
            });

            function showMetadata(result) {
                const metadataContent = document.getElementById('metadata-content');
                let content = '';

                // Format metadata based on result type
                switch(result.type) {
                    case 'artists':
                        // Get the preferred URL based on priority
                        let artistUrl = '';
                        let artistData = result.source.member || result.source;
                        console.log(result);
                        if (artistData.urlWikipedia) {
                            artistUrl = artistData.urlWikipedia;
                        } else if (artistData.urlWikidata) {
                            artistUrl = artistData.urlWikidata;
                        } else if (artistData.urls && artistData.urls.length > 0) {
                            artistUrl = artistData.urls[0];
                        }

                        let instruments = artistData.instruments ? artistData.instruments.map(instrument =>
                            instrument.charAt(0).toUpperCase() + instrument.slice(1)).join(', ') : '';

                        content = `
                            <h3>${result.source.member ? 'Artist Information' : 'Band Information'}</h3>
                            <p><strong>Name:</strong> ${result.title}</p>
                            ${artistData.realName && artistData.realName !== artistData.name ?
                                `<p><strong>Real Name:</strong> ${artistData.realName}</p>` : ''}
                            ${artistData.dbp_abstract ?
                                `<p><strong>Biography:</strong> ${artistData.dbp_abstract}</p>` :
                                artistData.abstract ?
                                `<p><strong>Biography:</strong> ${artistData.abstract}</p>` : ''}
                            ${artistUrl ? `<p><strong>More Info:</strong> <a href="${artistUrl}" target="_blank">${artistUrl}</a></p>` : ''}
                            ${instruments ?
                                `<p><strong>Instruments:</strong> ${instruments}</p>` : ''}
                            ${artistData.birthDate ? `<p><strong>Birth Date:</strong> ${artistData.birthDate}</p>` : ''}
                            ${artistData.subject ? `<p><strong>Categories:</strong> ${artistData.subject.join(', ')}</p>` : ''}
                            ${artistData.nameVariations && artistData.nameVariations.length > 0 ?
                                `<p><strong>Also Known As:</strong> ${artistData.nameVariations.join(', ')}</p>` : ''}
                            <div id="artist-songs" class="artist-songs">
                                <h4>Songs found on Spotify:</h4>
                                <div class="songs-list">Loading...</div>
                            </div>`;

                        // Display the content immediately
                        metadataContent.innerHTML = content;
                        metadataModal.style.display = 'block';
                        setTimeout(() => {
                            metadataModal.classList.add('show');
                        }, 10);
                        // Fetch and display the artist's songs
                        fetch(`/artist-songs/${encodeURIComponent(result.title)}`)
                            .then(response => response.json())
                            .then(data => {
                                const songsList = document.querySelector('.songs-list');
                                if (!songsList) return; // Modal might be closed

                                if (data.error) {
                                    songsList.innerHTML = `<p class="error">${data.error}</p>`;
                                    return;
                                }
                                if (!data.songs || data.songs.length === 0) {
                                    songsList.innerHTML = '<p>No songs found</p>';
                                    return;
                                }
                                songsList.innerHTML = `
                                    <div class="songs-grid">
                                        ${data.songs.map(song => `
                                            <div class="song-item">
                                                <img src="${song.image}" alt="${song.title}" class="song-image">
                                                <div class="song-info">
                                                    <h5>${song.title}</h5>
                                                    <p>${song.album}</p>
                                                    <button class="play-song-btn" data-uri="${song.external_url.split('track/')[1]}">
                                                        <i class="fas fa-play"></i> Play
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;

                                // Add event listeners for play buttons
                                const playButtons = document.querySelectorAll('.play-song-btn');
                                playButtons.forEach(button => {
                                    button.addEventListener('click', async (e) => {
                                        e.preventDefault();
                                        const trackId = button.dataset.uri;
                                        try {
                                            const response = await fetch('/play-track', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({ track_id: trackId })
                                            });
                                            if (!response.ok) {
                                                throw new Error('Failed to play track');
                                            }
                                            // Update the currently playing display
                                            setTimeout(updateCurrentlyPlaying, 500);
                                        } catch (error) {
                                            console.error('Error playing track:', error);
                                        }
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching songs:', error);
                                const songsList = document.querySelector('.songs-list');
                                if (songsList) {
                                    songsList.innerHTML = '<p class="error">Failed to load songs</p>';
                                }
                            });
                        break;

                    case 'albums':
                        content = `
                            <h3>Album Information</h3>
                            <p><strong>Title:</strong> ${result.title}</p>
                            ${result.source.genre ? `<p><strong>Genre:</strong> ${result.source.genre}</p>` : ''}
                            ${result.source.dateRelease ? `<p><strong>Release Date:</strong> ${result.source.dateRelease}</p>` : ''}
                            ${result.source.country ? `<p><strong>Country:</strong> ${result.source.country}</p>` : ''}
                        `;
                        metadataContent.innerHTML = content;
                        metadataModal.style.display = 'block';
                        setTimeout(() => {
                            metadataModal.classList.add('show');
                        }, 10);
                        break;

                    case 'songs':
                        content = `
                            <h3>Song Information</h3>
                            <p><strong>Title:</strong> ${result.title}</p>
                            ${result.source.albumTitle ? `<p><strong>Album:</strong> ${result.source.albumTitle}</p>` : ''}
                            ${result.source.album_genre ? `<p><strong>Genre:</strong> ${result.source.album_genre}</p>` : ''}
                            ${result.source.bpm ? `<p><strong>BPM:</strong> ${result.source.bpm}</p>` : ''}
                            ${result.source.language ? `<p><strong>Language:</strong> ${result.source.language}</p>` : ''}
                            ${result.source.lyrics ? `<div class="lyrics"><strong>Lyrics:</strong><br>${result.source.lyrics}</div>` : ''}
                        `;
                        metadataContent.innerHTML = content;
                        metadataModal.style.display = 'block';
                        setTimeout(() => {
                            metadataModal.classList.add('show');
                        }, 10);
                        break;
                }
            }

            function displayRankedResults(hits) {
                rankedResultsDiv.innerHTML = '';

                const resultsList = document.createElement('div');
                resultsList.className = 'ranked-results-list';

                hits.forEach((hit, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'ranked-result-item';
                    resultItem.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <span class="type ${hit.type}">${hit.type}</span>
                        <span class="title">${hit.title}</span>
                        <span class="snippet">${hit.content || ''}</span>
                    `;

                    // Add click event to show metadata
                    resultItem.addEventListener('click', () => showMetadata(hit));

                    resultsList.appendChild(resultItem);
                });

                rankedResultsDiv.appendChild(resultsList);
            }

            // Modal elements
            const modal = document.getElementById('top-items-modal');
            const showTopItemsBtn = document.getElementById('show-top-items');
            const closeModal = document.querySelector('.close-modal');

            // Modal controls
            showTopItemsBtn.addEventListener('click', () => {
                modal.style.display = 'block';
                // Small delay to trigger the transition
                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
                // Fetch data when modal is opened
                fetchTopTracks();
                fetchTopArtists();
            });

            closeModal.addEventListener('click', () => {
                modal.classList.remove('show');
                // Wait for transition to complete before hiding
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            });

            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.remove('show');
                    // Wait for transition to complete before hiding
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            });

            // Functions
            function formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            async function updateCurrentlyPlaying() {
                try {
                    const response = await fetch('/currently-playing');
                    const data = await response.json();
                    const trackName = data.track_name;
                    const artistName = data.artist_name;
                    const image = data.image;
                    const isPlaying = data.is_playing;
                    const progress = data.progress;
                    const duration = data.duration;

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    const playerBar = document.getElementById('player-bar');

                    // Update song info and album art
                    const playerSongName = document.getElementById('player-song-name');
                    const playerArtistName = document.getElementById('player-artist-name');
                    if (trackName && artistName) {
                        playerBar.classList.remove('hidden');
                        playerBar.classList.add('visible');
                        playerSongName.textContent = trackName;
                        playerArtistName.textContent = artistName;
                    } else {
                        playerBar.classList.add('hidden');
                        playerBar.classList.remove('visible');
                    }

                    const playerAlbumArt = document.getElementById('player-album-art');
                    if (image) {
                        playerAlbumArt.src = image;
                    }

                    // Update play/pause button
                    const playPauseIcon = document.getElementById('play-pause-icon');
                    if (isPlaying) {
                        playPauseIcon.classList.remove('fa-play');
                        playPauseIcon.classList.add('fa-pause');
                    } else {
                        playPauseIcon.classList.remove('fa-pause');
                        playPauseIcon.classList.add('fa-play');
                    }

                    // Update progress bar
                    const progressBar = document.getElementById('song-progress');
                    if (duration > 0) {
                        const progressPercent = (progress / duration) * 100;
                        progressBar.style.width = `${progressPercent}%`;
                    } else {
                        progressBar.style.width = '0%';
                    }

                    // Update time displays
                    document.getElementById('current-time').textContent = formatTime(progress);
                    document.getElementById('total-time').textContent = formatTime(duration);

                } catch (error) {
                    console.error('Error updating player:', error);
                }
            }

            async function performSearch() {
                const query = searchInput.value.trim();

                if (!query) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.textContent = '';

                try {
                    const response = await fetch(`/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    if (data.error) {
                        errorDiv.textContent = data.error;
                        return;
                    }

                    displayRankedResults(data.hits);
                    resultsDiv.style.display = 'block';
                } catch (error) {
                    errorDiv.textContent = 'An error occurred while searching. Please try again.';
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            // Event listeners and updates
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            updateCurrentlyPlaying();
            setInterval(updateCurrentlyPlaying, 3000); // Update every 3 seconds

            // Event listeners
            document.getElementById('play-pause-button').addEventListener('click', async function() {
                try {
                    const response = await fetch('/toggle-playback', { method: 'POST' });
                    if (response.ok) {
                        updateCurrentlyPlaying(); // Update the UI immediately after toggling
                    }
                } catch (error) {
                    console.error('Error toggling playback:', error);
                }
            });

            // Volume control
            const volumeSlider = document.querySelector('.volume-slider');
            const volumeProgress = document.querySelector('.volume-progress');
            const volumeIcon = document.querySelector('.player-volume i');
            let isDragging = false;
            let previousVolume = 100;

            function updateVolumeUI(volume) {
                volumeProgress.style.width = `${volume}%`;
                // Update volume icon based on level
                volumeIcon.className = 'fas ' + (
                    volume === 0 ? 'fa-volume-mute' :
                    volume < 30 ? 'fa-volume-off' :
                    volume < 70 ? 'fa-volume-down' :
                    'fa-volume-up'
                );
            }

            async function setVolume(volume) {
                try {
                    const response = await fetch('/set-volume', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ volume: Math.round(volume) })
                    });
                    if (!response.ok) {
                        throw new Error('Failed to set volume');
                    }
                } catch (error) {
                    console.error('Error setting volume:', error);
                }
            }

            volumeSlider.addEventListener('mousedown', (e) => {
                isDragging = true;
                const rect = volumeSlider.getBoundingClientRect();
                const volume = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
                updateVolumeUI(volume);
                setVolume(volume);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const rect = volumeSlider.getBoundingClientRect();
                    const volume = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
                    updateVolumeUI(volume);
                    setVolume(volume);
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            volumeIcon.addEventListener('click', () => {
                const currentWidth = parseFloat(volumeProgress.style.width) || 100;
                if (currentWidth > 0) {
                    previousVolume = currentWidth;
                    updateVolumeUI(0);
                    setVolume(0);
                } else {
                    updateVolumeUI(previousVolume);
                    setVolume(previousVolume);
                }
            });

            // Add event listeners for previous and next buttons
            document.querySelector('.fa-backward').parentElement.addEventListener('click', async function() {
                try {
                    const response = await fetch('/previous-track', { method: 'POST' });
                    if (response.ok) {
                        setTimeout(updateCurrentlyPlaying, 300); // Small delay to let Spotify update
                    } else {
                        const data = await response.json();
                        console.error('Error going to previous track:', data.error);
                    }
                } catch (error) {
                    console.error('Error going to previous track:', error);
                }
            });

            document.querySelector('.fa-forward').parentElement.addEventListener('click', async function() {
                try {
                    const response = await fetch('/next-track', { method: 'POST' });
                    if (response.ok) {
                        setTimeout(updateCurrentlyPlaying, 300); // Small delay to let Spotify update
                    } else {
                        const data = await response.json();
                        console.error('Error skipping to next track:', data.error);
                    }
                } catch (error) {
                    console.error('Error skipping to next track:', error);
                }
            });

            // Create minimal card for top tracks
            function createTopTrackCard(track) {
                return `
                    <div class="top-item-card">
                        <img src="${track.image || '/static/default-album.png'}" alt="${track.name}" class="top-item-image">
                        <div class="top-item-content">
                            <h3>${track.name}</h3>
                            <p>${track.artist}</p>
                        </div>
                    </div>
                `;
            }

            // Create minimal card for top artists
            function createTopArtistCard(artist) {
                return `
                    <div class="top-item-card">
                        <img src="${artist.image || '/static/default-artist.png'}" alt="${artist.name}" class="top-item-image">
                        <div class="top-item-content">
                            <h3>${artist.name}</h3>
                            <p>${artist.genres[0] || ''}</p>
                        </div>
                    </div>
                `;
            }

            // Function to fetch and display top tracks
            async function fetchTopTracks() {
                try {
                    const response = await fetch('/top-tracks');
                    const data = await response.json();

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    const container = document.getElementById('top-tracks-container');
                    container.innerHTML = data.tracks.map(createTopTrackCard).join('');
                } catch (error) {
                    console.error('Error fetching top tracks:', error);
                }
            }

            // Function to fetch and display top artists
            async function fetchTopArtists() {
                try {
                    const response = await fetch('/top-artists');
                    const data = await response.json();

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    const container = document.getElementById('top-artists-container');
                    container.innerHTML = data.artists.map(createTopArtistCard).join('');
                } catch (error) {
                    console.error('Error fetching top artists:', error);
                }
            }

            // Fetch top tracks and artists when page loads
            fetchTopTracks();
            fetchTopArtists();
        });
    </script>
</body>
</html>
